name: Scratch Parser CI-CD

on:
  pull_request: # Runs whenever a pull request is created or updated
  push: # Runs whenever a commit is pushed to the repository...
    branches: [master] # ...on any of these branches
concurrency:
  group: '${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}'
  cancel-in-progress: true

permissions: 
  contents: write
  pages: write
  issues: write
  pull-requests: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps: 
        - uses: actions/checkout@v4
        - uses: wagoid/commitlint-github-action@v5
        - uses: actions/setup-node@v4
          with:
            cache: "npm"
            node-version-file: ".nvmrc"
        - name: Info
          run: |
            cat <<EOF
            Node version: $(node --version)
            NPM version: $(npm --version)
            GitHub ref: ${{ github.ref }}
            GitHub head ref: ${{ github.head_ref }}
            EOF
        - name: Install NPM Dependencies
          run: |
            npm ci
        - name: Lint
          run: npm run test:lint
        - name: Run All Tests
          run: npm run test
        - name: Semantic Release
          if: github.ref == 'master'
          env:
            NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          run: npx --no -- semantic-release
